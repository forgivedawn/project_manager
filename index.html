<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>遊戲專案里程碑管理工具</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide-react@0.263.1/dist/umd/lucide-react.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { Plus, Edit, Trash2, Calendar, List, Save, X } = lucideReact;

        const GameProjectManager = () => {
            const [milestones, setMilestones] = useState([]);
            const [checkpoints, setCheckpoints] = useState([]);
            const [activeTab, setActiveTab] = useState('list');
            const [editingMilestone, setEditingMilestone] = useState(null);
            const [showForm, setShowForm] = useState(false);
            const [currentDate, setCurrentDate] = useState(new Date());
            const today = new Date();

            const [formData, setFormData] = useState({
                name: '',
                date: '',
                description: '',
                checkpointStartDate: ''
            });

            useEffect(() => {
                loadData();
            }, []);

            const loadData = () => {
                try {
                    const savedMilestones = localStorage.getItem('milestones');
                    const savedCheckpoints = localStorage.getItem('checkpoints');
                    if (savedMilestones) setMilestones(JSON.parse(savedMilestones));
                    if (savedCheckpoints) setCheckpoints(JSON.parse(savedCheckpoints));
                } catch (error) {
                    console.error('載入失敗:', error);
                }
            };

            const saveData = (milestoneData, checkpointData = checkpoints) => {
                localStorage.setItem('milestones', JSON.stringify(milestoneData));
                localStorage.setItem('checkpoints', JSON.stringify(checkpointData));
                console.log('milestone.json:', JSON.stringify(milestoneData, null, 2));
                console.log('checkpoints.json:', JSON.stringify(checkpointData, null, 2));
            };

            const generateTaskForCheckpoint = (milestone, checkpointDate) => {
                if (!milestone?.description) return '檢查進度並調整計劃';
                
                const days = Math.ceil((new Date(milestone.date) - new Date(checkpointDate)) / (1000 * 60 * 60 * 24));
                if (days === 0) return `${milestone.name}最終檢查：確認所有內容完成並進行交付準備`;
                
                return '檢查進度並調整計劃';
            };

            const findNearestMilestone = (checkpointDate, currentMilestone) => {
                const allMilestones = [...milestones, currentMilestone];
                const sorted = allMilestones
                    .filter(m => new Date(m.date) >= new Date(checkpointDate))
                    .sort((a, b) => new Date(a.date) - new Date(b.date));
                return sorted[0] || allMilestones[allMilestones.length - 1];
            };

            const generateCheckpoints = (milestoneData) => {
                if (!milestoneData.checkpointStartDate) return [];
                
                const startDate = new Date(milestoneData.checkpointStartDate);
                const endDate = new Date(milestoneData.date);
                const dates = [];
                
                let current = new Date(startDate);
                while (current.getDay() !== 3) current.setDate(current.getDate() + 1);
                
                while (current <= endDate) {
                    dates.push(new Date(current));
                    current.setDate(current.getDate() + 7);
                }
                
                if (!dates.some(d => d.toDateString() === endDate.toDateString())) {
                    dates.push(endDate);
                }
                
                return dates.map((date, i) => {
                    const dateStr = date.toISOString().split('T')[0];
                    const nearest = findNearestMilestone(dateStr, milestoneData);
                    return {
                        id: Date.now() + i,
                        milestoneId: nearest.id,
                        name: `${nearest.name} - 檢查點`,
                        date: dateStr,
                        description: generateTaskForCheckpoint(nearest, dateStr),
                        isCheckpoint: true
                    };
                });
            };

            const rebuildAllCheckpoints = () => {
                const allDates = new Set();
                
                milestones.forEach(m => {
                    if (!m.checkpointStartDate) return;
                    const start = new Date(m.checkpointStartDate);
                    const end = new Date(m.date);
                    
                    let current = new Date(start);
                    while (current.getDay() !== 3) current.setDate(current.getDate() + 1);
                    
                    while (current <= end) {
                        allDates.add(current.toISOString().split('T')[0]);
                        current.setDate(current.getDate() + 7);
                    }
                    allDates.add(end.toISOString().split('T')[0]);
                });
                
                const newCheckpoints = Array.from(allDates).sort().map((dateStr, i) => {
                    const nearest = milestones
                        .filter(m => new Date(m.date) >= new Date(dateStr))
                        .sort((a, b) => new Date(a.date) - new Date(b.date))[0];
                    
                    return nearest ? {
                        id: Date.now() + i,
                        milestoneId: nearest.id,
                        name: `${nearest.name} - 檢查點`,
                        date: dateStr,
                        description: generateTaskForCheckpoint(nearest, dateStr),
                        isCheckpoint: true
                    } : null;
                }).filter(Boolean);
                
                setCheckpoints(newCheckpoints);
                saveData(milestones, newCheckpoints);
                alert(`已重建 ${newCheckpoints.length} 個檢查點`);
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!formData.name || !formData.date) {
                    alert('請填入名稱和日期');
                    return;
                }
                
                let updatedMilestones, newCheckpoints = [];
                
                if (editingMilestone) {
                    updatedMilestones = milestones.map(m => 
                        m.id === editingMilestone.id ? { ...editingMilestone, ...formData } : m
                    );
                    
                    const filteredCheckpoints = checkpoints.filter(c => c.milestoneId !== editingMilestone.id);
                    if (formData.checkpointStartDate) {
                        newCheckpoints = generateCheckpoints({ ...editingMilestone, ...formData });
                        setCheckpoints([...filteredCheckpoints, ...newCheckpoints]);
                        saveData(updatedMilestones, [...filteredCheckpoints, ...newCheckpoints]);
                    } else {
                        setCheckpoints(filteredCheckpoints);
                        saveData(updatedMilestones, filteredCheckpoints);
                    }
                } else {
                    const newMilestone = { id: Date.now(), ...formData };
                    updatedMilestones = [...milestones, newMilestone];
                    
                    if (formData.checkpointStartDate) {
                        newCheckpoints = generateCheckpoints(newMilestone);
                        setCheckpoints([...checkpoints, ...newCheckpoints]);
                        saveData(updatedMilestones, [...checkpoints, ...newCheckpoints]);
                    } else {
                        saveData(updatedMilestones);
                    }
                }
                
                setMilestones(updatedMilestones);
                if (newCheckpoints.length > 0) {
                    alert(`已${editingMilestone ? '更新' : '新增'} ${newCheckpoints.length} 個檢查點`);
                }
                
                const next = updatedMilestones
                    .filter(m => new Date(m.date) > new Date())
                    .sort((a, b) => new Date(a.date) - new Date(b.date))[0];
                if (next) alert(`最近的里程碑: ${next.name} (${next.date})`);
                
                resetForm();
            };

            const resetForm = () => {
                setFormData({ name: '', date: '', description: '', checkpointStartDate: '' });
                setEditingMilestone(null);
                setShowForm(false);
            };

            const handleEdit = (milestone) => {
                setEditingMilestone(milestone);
                setFormData({
                    name: milestone.name,
                    date: milestone.date,
                    description: milestone.description,
                    checkpointStartDate: milestone.checkpointStartDate || ''
                });
                setShowForm(true);
            };

            const handleDelete = (id) => {
                const updatedMilestones = milestones.filter(m => m.id !== id);
                const updatedCheckpoints = checkpoints.filter(c => c.milestoneId !== id);
                setMilestones(updatedMilestones);
                setCheckpoints(updatedCheckpoints);
                saveData(updatedMilestones, updatedCheckpoints);
            };

            const getStatus = (date) => {
                const days = Math.ceil((new Date(date) - new Date()) / (1000 * 60 * 60 * 24));
                if (days < 0) return 'bg-red-100 text-red-800 border-red-200';
                if (days <= 7) return 'bg-orange-100 text-orange-800 border-orange-200';
                if (days <= 30) return 'bg-yellow-100 text-yellow-800 border-yellow-200';
                return 'bg-blue-100 text-blue-800 border-blue-200';
            };

            const isToday = (day) => {
                if (!day) return false;
                const checkDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                return checkDate.toDateString() === today.toDateString();
            };

            const generateCalendarDays = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const firstDay = new Date(year, month, 1);
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const startingDay = firstDay.getDay();
                
                const days = Array(startingDay).fill(null);
                for (let i = 1; i <= daysInMonth; i++) days.push(i);
                return days;
            };

            const getMilestonesForDate = (day) => {
                if (!day) return [];
                const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                return [...milestones, ...checkpoints].filter(item => item.date === dateStr);
            };

            const getGroupedCheckpoints = () => {
                return checkpoints.reduce((acc, checkpoint) => {
                    const milestone = milestones.find(m => m.id === checkpoint.milestoneId);
                    const name = milestone?.name || '未知里程碑';
                    if (!acc[name]) acc[name] = [];
                    acc[name].push(checkpoint);
                    return acc;
                }, {});
            };

            const nextMilestone = milestones
                .filter(m => new Date(m.date) > new Date())
                .sort((a, b) => new Date(a.date) - new Date(b.date))[0];

            return React.createElement('div', { className: "max-w-6xl mx-auto p-6 bg-white" },
                React.createElement('div', { className: "mb-6" },
                    React.createElement('h1', { className: "text-3xl font-bold text-gray-800 mb-2" }, "遊戲專案里程碑管理"),
                    nextMilestone && React.createElement('div', { className: "bg-green-50 border border-green-200 rounded-lg p-4" },
                        React.createElement('h3', { className: "font-semibold text-green-800" }, "最近里程碑"),
                        React.createElement('p', { className: "text-green-700" }, `${nextMilestone.name} - ${nextMilestone.date}`)
                    )
                ),

                React.createElement('div', { className: "flex border-b mb-6" },
                    [
                        { id: 'list', label: '里程碑列表', icon: List },
                        { id: 'calendar', label: '日曆視圖', icon: Calendar },
                        { id: 'checkpoints', label: '檢查點', icon: Calendar }
                    ].map(tab => React.createElement('button', {
                        key: tab.id,
                        onClick: () => setActiveTab(tab.id),
                        className: `px-6 py-3 font-medium ${activeTab === tab.id 
                            ? 'border-b-2 border-blue-500 text-blue-600' 
                            : 'text-gray-500 hover:text-gray-700'}`
                    },
                        React.createElement(tab.icon, { className: "inline-block w-4 h-4 mr-2" }),
                        tab.label
                    ))
                ),

                // 里程碑列表分頁
                activeTab === 'list' && React.createElement('div', {},
                    React.createElement('div', { className: "flex justify-between items-center mb-4" },
                        React.createElement('h2', { className: "text-xl font-semibold" }, "里程碑管理"),
                        React.createElement('button', {
                            onClick: () => setShowForm(true),
                            className: "bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2"
                        },
                            React.createElement(Plus, { className: "w-4 h-4" }),
                            "新增里程碑"
                        )
                    ),

                    showForm && React.createElement('div', { className: "bg-gray-50 border rounded-lg p-6 mb-6" },
                        React.createElement('div', { className: "flex justify-between items-center mb-4" },
                            React.createElement('h3', { className: "text-lg font-medium" },
                                editingMilestone ? '編輯里程碑' : '新增里程碑'
                            ),
                            React.createElement('button', {
                                onClick: resetForm,
                                className: "text-gray-500 hover:text-gray-700"
                            },
                                React.createElement(X, { className: "w-5 h-5" })
                            )
                        ),
                        
                        React.createElement('form', { onSubmit: handleSubmit, className: "space-y-4" },
                            React.createElement('div', {},
                                React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, "名稱"),
                                React.createElement('input', {
                                    type: "text",
                                    value: formData.name,
                                    onChange: (e) => setFormData({...formData, name: e.target.value}),
                                    className: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                })
                            ),
                            React.createElement('div', {},
                                React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, "日期"),
                                React.createElement('input', {
                                    type: "date",
                                    value: formData.date,
                                    onChange: (e) => setFormData({...formData, date: e.target.value}),
                                    className: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                })
                            ),
                            React.createElement('div', {},
                                React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, "描述"),
                                React.createElement('textarea', {
                                    value: formData.description,
                                    onChange: (e) => setFormData({...formData, description: e.target.value}),
                                    rows: "3",
                                    className: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",
                                    placeholder: "描述里程碑的目標和內容"
                                })
                            ),
                            React.createElement('div', {},
                                React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" },
                                    "檢查點起始日期 (選填)"
                                ),
                                React.createElement('input', {
                                    type: "date",
                                    value: formData.checkpointStartDate,
                                    onChange: (e) => setFormData({...formData, checkpointStartDate: e.target.value}),
                                    className: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                }),
                                React.createElement('p', { className: "text-xs text-gray-500 mt-1" },
                                    "設定後將自動在每週三和里程碑當天生成檢查點"
                                )
                            ),
                            React.createElement('div', { className: "flex gap-2" },
                                React.createElement('button', {
                                    type: "submit",
                                    className: "bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md flex items-center gap-2"
                                },
                                    React.createElement(Save, { className: "w-4 h-4" }),
                                    editingMilestone ? '更新' : '新增'
                                ),
                                React.createElement('button', {
                                    type: "button",
                                    onClick: resetForm,
                                    className: "bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md"
                                },
                                    "取消"
                                )
                            )
                        )
                    ),

                    React.createElement('div', { className: "space-y-3" },
                        milestones.length === 0 
                            ? React.createElement('p', { className: "text-gray-500 text-center py-8" }, "尚無里程碑資料")
                            : milestones
                                .sort((a, b) => new Date(a.date) - new Date(b.date))
                                .map(milestone => React.createElement('div', {
                                    key: milestone.id,
                                    className: `border rounded-lg p-4 ${getStatus(milestone.date)}`
                                },
                                    React.createElement('div', { className: "flex justify-between items-start" },
                                        React.createElement('div', { className: "flex-1" },
                                            React.createElement('h3', { className: "font-semibold text-lg" }, milestone.name),
                                            React.createElement('p', { className: "text-sm opacity-75 mb-2" }, milestone.date),
                                            milestone.description && React.createElement('p', { className: "text-sm" }, milestone.description)
                                        ),
                                        React.createElement('div', { className: "flex gap-2 ml-4" },
                                            React.createElement('button', {
                                                onClick: (e) => {
                                                    e.preventDefault();
                                                    e.stopPropagation();
                                                    handleEdit(milestone);
                                                },
                                                className: "p-2 hover:bg-white hover:bg-opacity-50 rounded"
                                            },
                                                React.createElement(Edit, { className: "w-4 h-4" })
                                            ),
                                            React.createElement('button', {
                                                onClick: (e) => {
                                                    e.preventDefault();
                                                    e.stopPropagation();
                                                    handleDelete(milestone.id);
                                                },
                                                className: "p-2 hover:bg-white hover:bg-opacity-50 rounded"
                                            },
                                                React.createElement(Trash2, { className: "w-4 h-4" })
                                            )
                                        )
                                    )
                                ))
                    )
                ),

                // 日曆視圖分頁
                activeTab === 'calendar' && React.createElement('div', { className: "grid grid-cols-1 lg:grid-cols-4 gap-6" },
                    React.createElement('div', { className: "lg:col-span-3" },
                        React.createElement('div', { className: "flex justify-between items-center mb-4" },
                            React.createElement('div', { className: "flex items-center gap-4" },
                                React.createElement('button', {
                                    onClick: () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1)),
                                    className: "p-2 hover:bg-gray-100 rounded-lg"
                                }, "←"),
                                React.createElement('h2', { className: "text-xl font-semibold" },
                                    `${currentDate.getFullYear()}年${currentDate.getMonth() + 1}月`
                                ),
                                React.createElement('button', {
                                    onClick: () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1)),
                                    className: "p-2 hover:bg-gray-100 rounded-lg"
                                }, "→")
                            ),
                            React.createElement('button', {
                                onClick: () => setCurrentDate(new Date()),
                                className: "bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm"
                            }, "今天")
                        ),
                        
                        React.createElement('div', { className: "grid grid-cols-7 gap-1 mb-2" },
                            ['日', '一', '二', '三', '四', '五', '六'].map(day =>
                                React.createElement('div', {
                                    key: day,
                                    className: "p-3 text-center font-medium text-gray-600 bg-gray-100"
                                }, day)
                            )
                        ),
                        
                        React.createElement('div', { className: "grid grid-cols-7 gap-1" },
                            generateCalendarDays().map((day, index) => {
                                const dayItems = getMilestonesForDate(day);
                                const isTodayDate = isToday(day);
                                return React.createElement('div', {
                                    key: index,
                                    className: `min-h-[100px] p-2 border ${
                                        day ? 'bg-white hover:bg-gray-50' : 'bg-gray-50'
                                    } ${isTodayDate ? 'bg-blue-50 border-blue-300 border-2' : ''}`
                                },
                                    day && React.createElement(React.Fragment, {},
                                        React.createElement('div', {
                                            className: `font-medium text-sm mb-1 ${
                                                isTodayDate ? 'text-blue-600 font-bold' : ''
                                            }`
                                        },
                                            day,
                                            isTodayDate && React.createElement('span', { className: "ml-1 text-xs" }, "(今天)")
                                        ),
                                        React.createElement('div', { className: "space-y-1" },
                                            dayItems.map(item => React.createElement('div', {
                                                key: item.id,
                                                className: `text-xs px-2 py-1 rounded truncate ${
                                                    item.isCheckpoint 
                                                        ? 'bg-green-100 text-green-800' 
                                                        : 'bg-blue-100 text-blue-800'
                                                }`,
                                                title: `${item.name}: ${item.description}`
                                            },
                                                item.isCheckpoint ? '✓ ' : '',
                                                item.name
                                            ))
                                        )
                                    )
                                );
                            })
                        )
                    ),

                    React.createElement('div', { className: "lg:col-span-1" },
                        React.createElement('h3', { className: "text-lg font-semibold mb-4" }, "所有事件"),
                        React.createElement('div', { className: "space-y-2 max-h-96 overflow-y-auto" },
                            [...milestones, ...checkpoints].length === 0 
                                ? React.createElement('p', { className: "text-gray-500 text-sm" }, "尚無事件")
                                : [...milestones, ...checkpoints]
                                    .sort((a, b) => new Date(a.date) - new Date(b.date))
                                    .map(item => React.createElement('div', {
                                        key: `${item.isCheckpoint ? 'cp' : 'm'}-${item.id}`,
                                        className: `border rounded p-3 text-sm ${getStatus(item.date)}`
                                    },
                                        React.createElement('div', { className: "font-medium" },
                                            item.isCheckpoint ? '✓ ' : '',
                                            item.name
                                        ),
                                        React.createElement('div', { className: "text-xs opacity-75 mt-1" }, item.date),
                                        item.description && React.createElement('div', { className: "text-xs mt-1" }, item.description)
                                    ))
                        )
                    )
                ),

                // 檢查點分頁
                activeTab === 'checkpoints' && React.createElement('div', {},
                    React.createElement('div', { className: "flex justify-between items-center mb-4" },
                        React.createElement('h2', { className: "text-xl font-semibold" }, "檢查點管理"),
                        React.createElement('button', {
                            onClick: rebuildAllCheckpoints,
                            className: "bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg flex items-center gap-2"
                        },
                            React.createElement(Calendar, { className: "w-4 h-4" }),
                            "重建所有檢查點"
                        )
                    ),

                    React.createElement('div', { className: "space-y-3" },
                        checkpoints.length === 0 
                            ? React.createElement('div', { className: "text-gray-500 text-center py-8" },
                                React.createElement('p', {}, "尚無檢查點資料"),
                                React.createElement('p', {}, "新增里程碑時設定檢查點起始日期即可自動生成")
                            )
                            : Object.entries(getGroupedCheckpoints()).map(([milestoneName, milestoneCheckpoints]) =>
                                React.createElement('div', {
                                    key: milestoneName,
                                    className: "border rounded-lg p-4 bg-gray-50"
                                },
                                    React.createElement('h3', { className: "font-semibold text-lg mb-3 text-gray-800" }, milestoneName),
                                    React.createElement('div', { className: "space-y-2" },
                                        milestoneCheckpoints.map(checkpoint => React.createElement('div', {
                                            key: checkpoint.id,
                                            className: `border rounded-lg p-3 ${getStatus(checkpoint.date)}`
                                        },
                                            React.createElement('div', { className: "flex justify-between items-start" },
                                                React.createElement('div', { className: "flex-1" },
                                                    React.createElement('h4', { className: "font-medium" }, `✓ ${checkpoint.name}`),
                                                    React.createElement('p', { className: "text-sm opacity-75 mb-1" }, checkpoint.date),
                                                    checkpoint.description && React.createElement('p', { className: "text-sm" }, checkpoint.description)
                                                )
                                            )
                                        ))
                                    )
                                )
                            )
                    )
                )
            );
        };

        ReactDOM.render(React.createElement(GameProjectManager), document.getElementById('root'));
    </script>
</body>
</html>